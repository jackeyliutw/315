<!DOCTYPE html>
<html>
<head>
    <title>54-2</title>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.36/dist/web3.min.js" integrity="sha256-nWBTbvxhJgjslRyuAKJHK+XcZPlCnmIAAMixz6EefVk=" crossorigin="anonymous"></script>
</head>
<body>

    <h1 id="myh1">天天分紅</h1>
    <p>我的地址:<span id="my_address"></span></p>
    <p>我的餘額:<span id="my_balance"></span></p>
    <hr/>
    <p>目前合約總獎池:<span id="total_balance"></span></p>
    <p>目前合約參與人數:<span id="join_count"></span></p>
    <p>目前總參與地址:<span id="join_address"></span></p>
    <ol id="join_address">

    </ol>

    <button id="invest" onclick="invest()">購買-投資</button>  <!--onclick是按下會啟動甚麼func-->
    </br>
    <button id="distribute" onclick=>分紅</button>
        
    <script>
        if (typeof web3 !== 'undefined') {
            web3 = new Web3(web3.currentProvider);
        }else{
            web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
            }
            
        var myContract;
        var coinbase;
        var balance;
//帳戶
        async function printPostsToConsole() {
            coinbase = await web3.eth.getCoinbase();
            balance = await web3.eth.getBalance(coinbase);
            /*alert(balance);*/
            $("#my_address").text(coinbase);
            $("#my_balance").text(web3.utils.fromWei(balance)+" ether");
//合約
            var contract_address = "0x6500111a2fdb8d5d1e0f6ac19988fc7d16201f82";
            var contract_abi = [ { "inputs": [], "name": "distribute", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "invest", "outputs": [], "stateMutability": "payable", "type": "function" }, { "inputs": [], "stateMutability": "nonpayable", "type": "constructor" }, { "inputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "name": "investors", "outputs": [ { "internalType": "address payable", "name": "", "type": "address" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "name": "investorTokens", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "owner", "outputs": [ { "internalType": "address", "name": "", "type": "address" } ], "stateMutability": "view", "type": "function" } ];
            myContract = new web3.eth.Contract(contract_abi,  contract_address);
//總累積金額
            var balance_contract = await web3.eth.getBalance(contract_address);
            $("#total_balance").text(web3.utils.fromWei(balance_contract)+" ether");
//目前總參與地址
            var contract_investors = await myContract.methods.investors(0).call({from: '0x6500111a2fdb8d5d1e0f6ac19988fc7d16201f82'});//from任意地址?

            $("#join_address").text(contract_investors);
            $("ol").append("<li></li>");
            for (i=0;i<=100;i++){
                contract_investors = await myContract.methods.investors(i).call({from: '0x6500111a2fdb8d5d1e0f6ac19988fc7d16201f82'});
                $("ol").append(contract_investors);
                $("ol").append("<li></li>");
                };
            };
//
            printPostsToConsole();
//
            function invest(){
                myContract.methods.invest().send({from:coinbase, value:"10000000000000000"}).then(function(receipt){
                    alert ("交易完成");
                    location.reload();//畫面重整
                });//這行的invest()不是指函數 是remix裡的方法按鈕 then是挖到後做的動作
                //alert ();
            };

    </script>

</body>
</html>
